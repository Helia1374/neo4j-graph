<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Graph Explorer</title>

  <script src="https://unpkg.com/cytoscape@3.26.0/dist/cytoscape.min.js"></script>
  <script src="https://unpkg.com/layout-base@2.0.1/layout-base.js"></script>
  <script src="https://unpkg.com/cose-base@2.2.0/cose-base.js"></script>
  <script src="https://unpkg.com/cytoscape-cose-bilkent@4.1.0/cytoscape-cose-bilkent.js"></script>

  <style>
    html, body { width:100%; height:100%; margin:0; font-family: Arial, sans-serif; background:#070A12; }
    #app { display:flex; width:100%; height:100%; }
    #cy {
      flex: 1;
      height: 100%;
      background: radial-gradient(circle at 30% 20%, #0b1230 0%, #070A12 45%, #050711 100%);
    }
    #side {
      width: 360px;
      border-left: 1px solid rgba(255,255,255,0.08);
      padding: 12px;
      box-sizing: border-box;
      overflow: auto;
      background: linear-gradient(180deg, rgba(15,18,34,0.98), rgba(8,10,18,0.98));
      color: #E9ECFF;
    }
    #toolbar {
      position: fixed;
      top: 12px; left: 12px;
      z-index: 999;
      background: rgba(10,12,22,0.85);
      border: 1px solid rgba(255,255,255,0.10);
      border-radius: 12px;
      box-shadow: 0 8px 30px rgba(0,0,0,0.45);
      padding: 10px 12px;
      display: flex;
      gap: 8px;
      align-items: center;
      backdrop-filter: blur(8px);
      color: #E9ECFF;
      max-width: 980px;
    }
    .btn {
      border: 1px solid rgba(255,255,255,0.18);
      background: rgba(255,255,255,0.06);
      color: #E9ECFF;
      padding: 7px 10px;
      border-radius: 10px;
      cursor: pointer;
      user-select: none;
    }
    .btn:hover { background: rgba(255,255,255,0.12); }
    #search {
      width: 280px;
      padding: 8px 10px;
      border-radius: 10px;
      border: 1px solid rgba(255,255,255,0.18);
      background: rgba(255,255,255,0.06);
      color: #E9ECFF;
      outline: none;
    }
    #search::placeholder { color: rgba(233,236,255,0.6); }
    h3 { margin: 8px 0 10px; }
    .muted { color: rgba(233,236,255,0.65); font-size: 12px; line-height: 1.4; }
    .kv { margin: 10px 0; }
    .k { font-size: 12px; color: rgba(233,236,255,0.65); }
    .v { font-size: 13px; word-break: break-word; color: #E9ECFF; }
    code { background: rgba(255,255,255,0.08); padding: 1px 6px; border-radius: 6px; }
    hr { border: 0; border-top: 1px solid rgba(255,255,255,0.10); margin: 10px 0; }
  </style>
</head>

<body>
  <div id="toolbar">
    <div style="font-weight:700;">⚡ Graph Explorer</div>
    <div class="btn" id="btnHome">Home</div>
    <div class="btn" id="btnShowAll">Show all</div>
    <input id="search" placeholder="Search (any property), press Enter" />
    <div class="muted">Single click = details • Double click = expand</div>
  </div>

  <div id="app">
    <div id="cy"></div>
    <div id="side">
      <h3>Details</h3>
      <div id="details" class="muted">Single click a node for details. Double click to expand.</div>
      <hr />
      <div class="muted">Home should show exactly 3 nodes (the hubs).</div>
    </div>
  </div>

<script>
  const COLORS = {
    HUB: "#B8BFFF",
    CircularValueChain: "#00E5FF",
    Partner: "#FF2BD6",
    Deliverable: "#9BFF3A",
    Other: "#FFD34A"
  };

  const HUBS = [
    { id: "HUB_CVC", label: "CircularValueChain", title: "Circular Value Chains" },
    { id: "HUB_PARTNER", label: "Partner", title: "Partners" },
    { id: "HUB_DELIV", label: "Deliverable", title: "Deliverables" }
  ];

  let cy;

  function unwrapNeo4jBrowserJson(raw) {
    if (Array.isArray(raw) && raw[0] && raw[0].json && raw[0].json.elements) return raw[0].json.elements;
    return raw?.elements ?? null;
  }

  function labelColor(label) {
    if (label === "Partner") return COLORS.Partner;
    if (label === "Deliverable") return COLORS.Deliverable;
    if (label === "CircularValueChain") return COLORS.CircularValueChain;
    return COLORS.Other;
  }

  function nodeDisplayTitle(d) {
    const label = (d.labels && d.labels[0]) || "Other";
    if (label === "Partner") return d.partners || d.partners_legalname || d.id;
    if (label === "Deliverable") return d.deliverables_no || d.deliverables_name || d.id;
    if (label === "CircularValueChain") return d.value_chains || d.id;
    return d.phase_id || d.demonstrations || d.id;
  }

  function showDetails(ele) {
    const d = ele.data();
    const head = `
      <div style="font-weight:700; font-size:16px; margin-bottom:6px;">${d.title || d.label || "Node"}</div>
      <div class="muted">Type: <code>${d.label || "Node"}</code></div>
      <hr />
    `;

    if (d.kind === "hub") {
      document.getElementById("details").innerHTML = head + `
        <div class="muted">
          This is a category hub (visual-only).<br><br>
          Double click to reveal its nodes.
        </div>`;
      return;
    }

    const rows = Object.entries(d)
      .filter(([k]) => !["color","title","kind"].includes(k))
      .sort((a,b) => a[0].localeCompare(b[0]))
      .map(([k,v]) => `<div class="kv"><div class="k">${k}</div><div class="v">${String(v)}</div></div>`)
      .join("");

    document.getElementById("details").innerHTML = head + (rows || `<div class="muted">No properties</div>`);
  }

  // ---- VIEWS ----
  function homeView() {
    // Hide everything
    cy.elements().addClass("hidden");

    // Show ONLY hubs (exactly 3)
    cy.$('node[kind = "hub"]').removeClass("hidden");

    // Hide ALL edges
    cy.edges().addClass("hidden");

    cy.layout({ name: "grid", animate: true, animationDuration: 600, fit: false, padding: 80 }).run();

    document.getElementById("details").innerHTML =
      `<div class="muted">Home loaded. You should see exactly <b>3</b> hubs. Double click one hub to reveal that category.</div>`;
  }

  function showAllGraph() {
    cy.elements().removeClass("hidden");
    cy.layout({
      name: "cose-bilkent",
      animate: true,
      animationDuration: 900,
      fit: false,
      padding: 40,
      randomize: false,
      nodeRepulsion: 14000,
      idealEdgeLength: 120,
      edgeElasticity: 0.25,
      gravity: 0.15
    }).run();
  }

  function revealCategory(label) {
    const hubId = label === "CircularValueChain" ? "HUB_CVC" :
                  label === "Partner" ? "HUB_PARTNER" : "HUB_DELIV";

    // Hide all, show hubs + this label's nodes
    cy.elements().addClass("hidden");
    cy.$('node[kind = "hub"]').removeClass("hidden");

    const groupNodes = cy.nodes().filter(n => n.data("kind") === "real" && n.data("label") === label);
    groupNodes.removeClass("hidden");

    // Synthetic hub edges (only once)
    const newEdges = [];
    groupNodes.forEach(n => {
      const eid = `HE_${hubId}_${n.id()}`;
      if (cy.getElementById(eid).empty()) {
        newEdges.push({ group:"edges", data:{ id:eid, source:hubId, target:n.id(), label:"contains", kind:"hubEdge" }});
      } else {
        cy.getElementById(eid).removeClass("hidden");
      }
    });
    if (newEdges.length) cy.add(newEdges);

    // Show only hub edges for this hub
    cy.edges().addClass("hidden");
    cy.edges().filter(e => e.data("kind") === "hubEdge" && e.data("source") === hubId).removeClass("hidden");

    // Layout around hub without zooming out
    cy.layout({
      name: "concentric",
      animate: true,
      animationDuration: 700,
      fit: false,
      padding: 80,
      concentric: (n) => n.id() === hubId ? 100 : 20,
      levelWidth: () => 1
    }).run();

    document.getElementById("details").innerHTML =
      `<div class="muted"><b>${label}</b> revealed. Single click nodes for details. Double click a node to expand its real neighbors.</div>`;
  }

  function expandRealNeighbors(node) {
    node.removeClass("hidden");

    const realEdges = node.connectedEdges().filter(e => e.data("kind") !== "hubEdge");
    const neighbors = realEdges.connectedNodes();

    realEdges.removeClass("hidden");
    neighbors.removeClass("hidden");

    cy.$('node[kind = "hub"]').removeClass("hidden");

    cy.layout({
      name: "cose-bilkent",
      animate: true,
      animationDuration: 650,
      fit: false,
      padding: 40,
      randomize: false,
      nodeRepulsion: 14000,
      idealEdgeLength: 120,
      gravity: 0.18
    }).run();
  }

  // ---- DOUBLE CLICK DETECTION ----
  let lastTapTime = 0;
  let lastTapId = null;

  function handleTap(ele) {
    const now = Date.now();
    const id = ele.id();
    const isDouble = (lastTapId === id && (now - lastTapTime) < 350);
    lastTapTime = now;
    lastTapId = id;

    if (!isDouble) {
      showDetails(ele);
      return;
    }

    const d = ele.data();
    if (d.kind === "hub") {
      revealCategory(d.label);
    } else {
      expandRealNeighbors(ele);
    }
  }

  async function main() {
    const res = await fetch("./graph.json");
    const raw = await res.json();
    const elements = unwrapNeo4jBrowserJson(raw);

    if (!elements?.nodes || !elements?.edges) {
      document.getElementById("details").innerHTML =
        "<b>Error</b><br><br>graph.json could not be loaded. Make sure it is in the repo root.";
      return;
    }

    // Real nodes
    const realNodes = elements.nodes.map(n => {
      const d = n.data || {};
      const label = (d.labels && d.labels[0]) || "Other";
      return {
        data: {
          ...d,
          label,
          title: nodeDisplayTitle(d),
          color: labelColor(label),
          kind: "real"
        }
      };
    });

    // Real edges
    const realEdges = elements.edges.map(e => {
      const d = e.data || {};
      return {
        data: {
          ...d,
          label: d.type || "REL",
          kind: "realEdge"
        }
      };
    });

    // Hub nodes
    const hubNodes = HUBS.map(h => ({
      data: { id: h.id, label: h.label, title: h.title, color: COLORS.HUB, kind: "hub" }
    }));

    cy = cytoscape({
      container: document.getElementById("cy"),
      elements: { nodes: [...hubNodes, ...realNodes], edges: realEdges },
      style: [
        { selector: ".hidden", style: { "display": "none" } },

        { selector: "node", style: {
          "background-color": "data(color)",
          "width": 18, "height": 18,
          "border-width": 2,
          "border-color": "data(color)",
          "label": "data(title)",
          "color": "#E9ECFF",
          "font-size": 11,
          "text-wrap": "wrap",
          "text-max-width": 140,
          "text-outline-width": 3,
          "text-outline-color": "#050711"
        }},
        { selector: 'node[kind = "hub"]', style: {
          "width": 80, "height": 80,
          "border-width": 3,
          "font-size": 16,
          "text-max-width": 200
        }},

        { selector: "edge", style: {
          "curve-style": "bezier",
          "line-color": "rgba(180,200,255,0.22)",
          "width": 2,
          "target-arrow-shape": "triangle",
          "target-arrow-color": "rgba(180,200,255,0.35)",
          "label": "data(label)",
          "font-size": 9,
          "color": "rgba(233,236,255,0.55)",
          "text-outline-width": 2,
          "text-outline-color": "#050711"
        }},
        { selector: 'edge[kind = "hubEdge"]', style: {
          "line-color": "rgba(233,236,255,0.28)",
          "target-arrow-color": "rgba(233,236,255,0.35)",
          "width": 2.5
        }}
      ]
    });

    // click handler
    cy.on("tap", "node", (evt) => handleTap(evt.target));

    // Search (single reveal + center, no zoom change)
    document.getElementById("search").addEventListener("keydown", (e) => {
      if (e.key !== "Enter") return;
      const q = e.target.value.trim().toLowerCase();
      if (!q) return;

      const hit = cy.nodes().filter(n => {
        const d = n.data();
        if (d.kind !== "real") return false;
        return Object.values(d).some(v => String(v).toLowerCase().includes(q));
      }).first();

      if (hit && hit.length) {
        hit.removeClass("hidden");
        showDetails(hit);
        cy.animate({ center: { eles: hit } }, { duration: 250 });
      }
    });

    document.getElementById("btnHome").onclick = () => homeView();
    document.getElementById("btnShowAll").onclick = () => showAllGraph();

    // start
    homeView();
  }

  main().catch(err => {
    console.error(err);
    document.getElementById("details").innerHTML = "<b>Error</b><br><br>" + String(err);
  });
</script>
</body>
</html>
