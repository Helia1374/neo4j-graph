<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Graph Explorer</title>

  <!-- Cytoscape core -->
  <script src="https://unpkg.com/cytoscape@3.26.0/dist/cytoscape.min.js"></script>

  <!-- Force layout for dramatic motion -->
  <script src="https://unpkg.com/layout-base@2.0.1/layout-base.js"></script>
  <script src="https://unpkg.com/cose-base@2.2.0/cose-base.js"></script>
  <script src="https://unpkg.com/cytoscape-cose-bilkent@4.1.0/cytoscape-cose-bilkent.js"></script>

  <style>
    html, body { width: 100%; height: 100%; margin: 0; font-family: Arial, sans-serif; background: #070A12; }
    #app { display: flex; width: 100%; height: 100%; }

    #cy {
      flex: 1;
      height: 100%;
      background: radial-gradient(circle at 30% 20%, #0b1230 0%, #070A12 45%, #050711 100%);
    }

    #side {
      width: 360px;
      border-left: 1px solid rgba(255,255,255,0.08);
      padding: 12px;
      box-sizing: border-box;
      overflow: auto;
      background: linear-gradient(180deg, rgba(15,18,34,0.98), rgba(8,10,18,0.98));
      color: #E9ECFF;
    }

    #toolbar {
      position: fixed;
      top: 12px;
      left: 12px;
      z-index: 999;
      background: rgba(10,12,22,0.85);
      border: 1px solid rgba(255,255,255,0.10);
      border-radius: 12px;
      box-shadow: 0 8px 30px rgba(0,0,0,0.45);
      padding: 10px 12px;
      display: flex;
      gap: 8px;
      align-items: center;
      backdrop-filter: blur(8px);
      color: #E9ECFF;
      max-width: 820px;
    }

    .btn {
      border: 1px solid rgba(255,255,255,0.18);
      background: rgba(255,255,255,0.06);
      color: #E9ECFF;
      padding: 7px 10px;
      border-radius: 10px;
      cursor: pointer;
      transition: transform 0.08s ease, background 0.15s ease;
      user-select: none;
    }
    .btn:hover { background: rgba(255,255,255,0.12); transform: translateY(-1px); }
    .btn:active { transform: translateY(0px); }

    #search {
      width: 260px;
      padding: 8px 10px;
      border-radius: 10px;
      border: 1px solid rgba(255,255,255,0.18);
      background: rgba(255,255,255,0.06);
      color: #E9ECFF;
      outline: none;
    }
    #search::placeholder { color: rgba(233,236,255,0.6); }

    #legend {
      position: fixed;
      bottom: 14px;
      left: 14px;
      z-index: 999;
      background: rgba(10,12,22,0.80);
      border: 1px solid rgba(255,255,255,0.10);
      border-radius: 12px;
      box-shadow: 0 8px 30px rgba(0,0,0,0.45);
      padding: 10px 12px;
      color: #E9ECFF;
      font-size: 13px;
      backdrop-filter: blur(8px);
      max-width: 360px;
    }
    .lg-row { display:flex; align-items:center; gap:8px; margin: 6px 0; }
    .swatch { width: 12px; height: 12px; border-radius: 4px; box-shadow: 0 0 14px currentColor; }

    h3 { margin: 8px 0 10px; }
    .muted { color: rgba(233,236,255,0.65); font-size: 12px; line-height: 1.4; }

    .kv { margin: 10px 0; }
    .k { font-size: 12px; color: rgba(233,236,255,0.65); }
    .v { font-size: 13px; word-break: break-word; color: #E9ECFF; }
    code { background: rgba(255,255,255,0.08); padding: 1px 6px; border-radius: 6px; }
    hr { border: 0; border-top: 1px solid rgba(255,255,255,0.10); margin: 10px 0; }
  </style>
</head>

<body>
  <div id="toolbar">
    <div style="font-weight:700; letter-spacing:0.3px;">⚡ Graph Explorer</div>
    <div class="btn" id="btnHome">Home</div>
    <div class="btn" id="btnShowAll">Show all</div>
    <div class="btn" id="btnFreeze">Freeze</div>
    <div class="btn" id="btnUnfreeze">Unfreeze</div>
    <input id="search" placeholder="Search any property, press Enter" />
    <div class="muted">Hover = neon highlight • Click = expand</div>
  </div>

  <div id="legend">
    <div style="font-weight:700; margin-bottom:6px;">Legend</div>
    <div class="lg-row"><div class="swatch" style="color:#00E5FF; background:#00E5FF;"></div> CircularValueChain</div>
    <div class="lg-row"><div class="swatch" style="color:#FF2BD6; background:#FF2BD6;"></div> Partner</div>
    <div class="lg-row"><div class="swatch" style="color:#9BFF3A; background:#9BFF3A;"></div> Deliverable</div>
    <div class="lg-row"><div class="swatch" style="color:#FFD34A; background:#FFD34A;"></div> Phase / Other</div>
    <div class="muted" style="margin-top:6px;">
      Start view shows only the 3 anchor types (no edges). Click nodes to reveal neighbors.
    </div>
  </div>

  <div id="app">
    <div id="cy"></div>
    <div id="side">
      <h3>Details</h3>
      <div id="details" class="muted">Click a node to view all properties. Neighbors will expand.</div>
      <hr />
      <div class="muted">
        Tip: If it gets too busy, press <b>Home</b> to reset to the clean landing view.
      </div>
    </div>
  </div>

<script>
  const LANDING_LABELS = new Set(["CircularValueChain", "Partner", "Deliverable"]);
  const LABEL_COLORS = {
    CircularValueChain: "#00E5FF",
    Partner: "#FF2BD6",
    Deliverable: "#9BFF3A",
    Phase: "#FFD34A",
    Demonstration: "#FFD34A",
    Innovation: "#FFD34A"
  };

  function unwrapNeo4jBrowserJson(raw) {
    // Neo4j Browser export usually: [ { "json": { "elements": { ... } } } ]
    if (Array.isArray(raw) && raw[0] && raw[0].json && raw[0].json.elements) return raw[0].json.elements;
    if (raw && raw.elements) return raw.elements;
    return null;
  }

  function pickTitle(d) {
    return d.partners_legalname
      || d.deliverables_name
      || d.phase_id
      || d.value_chains
      || d.demonstrations
      || d.id
      || (d.labels && d.labels[0])
      || "Node";
  }

  let cy;

  function landingLayout() {
    // Clean, intentional layout for the first impression
    cy.layout({
      name: "concentric",
      animate: true,
      animationDuration: 600,
      fit: true,
      padding: 60,
      concentric: (n) => {
        const lab = n.data("label") || "";
        if (lab === "CircularValueChain") return 100;
        if (lab === "Partner") return 60;
        if (lab === "Deliverable") return 40;
        return 10;
      },
      levelWidth: () => 1
    }).run();
  }

  function dramaticLayout() {
    // Flashy “motion” layout for exploration
    cy.layout({
      name: "cose-bilkent",
      animate: true,
      animationDuration: 900,
      fit: true,
      padding: 40,
      randomize: false,
      nodeRepulsion: 12000,
      idealEdgeLength: 120,
      edgeElasticity: 0.25,
      gravity: 0.2,
      nestingFactor: 1.2
    }).run();
  }

  function hideAll() {
    cy.elements().addClass("hidden");
  }

  function showAnchorsOnly() {
    // Show ONLY anchor nodes, NO edges, NO neighbors
    hideAll();
    cy.nodes().filter(n => LANDING_LABELS.has(n.data("label"))).removeClass("hidden");
    landingLayout();
    document.getElementById("details").innerHTML =
      "<div class='muted'>Clean landing view loaded. Click a node to expand neighbors and view properties.</div>";
  }

  function showAllGraph() {
    cy.elements().removeClass("hidden");
    dramaticLayout();
  }

  function showDetails(ele) {
    const d = ele.data();
    const label = d.label || (d.labels && d.labels[0]) || "Node";

    const rows = Object.entries(d)
      .filter(([k]) => !["title"].includes(k))
      .sort((a,b) => a[0].localeCompare(b[0]))
      .map(([k,v]) => `
        <div class="kv">
          <div class="k">${k}</div>
          <div class="v">${String(v)}</div>
        </div>
      `).join("");

    document.getElementById("details").innerHTML = `
      <div style="font-weight:700; font-size:16px; margin-bottom:6px;">${ele.data("title") || label}</div>
      <div class="muted">Type: <code>${label}</code></div>
      <hr />
      ${rows || "<div class='muted'>No properties</div>"}
    `;
  }

  function expandOneHop(node) {
    // Controlled expansion: only direct neighbors + connecting edges
    const edges = node.connectedEdges();
    const neighbors = edges.connectedNodes();
    node.removeClass("hidden");
    edges.removeClass("hidden");
    neighbors.removeClass("hidden");
    dramaticLayout();
  }

  function dimAll(on) {
    if (on) {
      cy.elements().addClass("dim");
    } else {
      cy.elements().removeClass("dim");
    }
  }

  function highlightNeighborhood(node) {
    dimAll(true);
    const hood = node.closedNeighborhood();
    hood.removeClass("dim");
    hood.addClass("hi");
  }

  function clearHighlights() {
    cy.elements().removeClass("hi");
    dimAll(false);
  }

  async function main() {
    const res = await fetch("./graph.json");
    const raw = await res.json();
    const elements = unwrapNeo4jBrowserJson(raw);

    if (!elements || !elements.nodes || !elements.edges) {
      document.getElementById("details").innerHTML =
        "<b>Could not load graph.json</b><br><br>Check that graph.json exists in the repo root.";
      return;
    }

    const nodes = elements.nodes.map(n => {
      const d = n.data || {};
      const label = (d.labels && d.labels[0]) || "Other";
      const color = LABEL_COLORS[label] || "#FFD34A";

      return {
        data: {
          ...d,
          label,
          color,
          title: pickTitle(d)
        }
      };
    });

    const edges = elements.edges.map(e => {
      const d = e.data || {};
      return {
        data: {
          ...d,
          label: d.type || "REL"
        }
      };
    });

    cy = cytoscape({
      container: document.getElementById("cy"),
      elements: { nodes, edges },
      style: [
        // Hidden
        { selector: ".hidden", style: { "display": "none" } },

        // Dim & highlight classes
        { selector: ".dim", style: { "opacity": 0.12 } },
        { selector: ".hi", style: { "opacity": 1 } },

        // Nodes
        {
          selector: "node",
          style: {
            "background-color": "data(color)",
            "width": 18,
            "height": 18,
            "border-width": 2,
            "border-color": "data(color)",
            "label": "data(title)",
            "color": "#E9ECFF",
            "font-size": 11,
            "text-wrap": "wrap",
            "text-max-width": 140,
            "text-outline-width": 3,
            "text-outline-color": "#050711"
          }
        },
        // Make anchor nodes bigger
        {
          selector: 'node[label = "CircularValueChain"]',
          style: { "width": 36, "height": 36, "border-width": 3, "font-size": 12 }
        },
        {
          selector: 'node[label = "Partner"]',
          style: { "width": 26, "height": 26, "border-width": 2 }
        },
        {
          selector: 'node[label = "Deliverable"]',
          style: { "width": 24, "height": 24, "border-width": 2 }
        },

        // Edges
        {
          selector: "edge",
          style: {
            "curve-style": "bezier",
            "line-color": "rgba(180,200,255,0.28)",
            "width": 2,
            "target-arrow-shape": "triangle",
            "target-arrow-color": "rgba(180,200,255,0.45)",
            "arrow-scale": 1.1,
            "label": "data(label)",
            "font-size": 9,
            "color": "rgba(233,236,255,0.65)",
            "text-outline-width": 2,
            "text-outline-color": "#050711"
          }
        }
      ]
    });

    // Hover highlight
    cy.on("mouseover", "node", (evt) => highlightNeighborhood(evt.target));
    cy.on("mouseout", "node", () => clearHighlights());

    // Click expand + details
    cy.on("tap", "node", (evt) => {
      const n = evt.target;
      showDetails(n);
      expandOneHop(n);
    });

    // Buttons
    document.getElementById("btnHome").onclick = () => showAnchorsOnly();
    document.getElementById("btnShowAll").onclick = () => showAllGraph();

    document.getElementById("btnFreeze").onclick = () => cy.nodes().lock();
    document.getElementById("btnUnfreeze").onclick = () => cy.nodes().unlock();

    // Search (any property)
    document.getElementById("search").addEventListener("keydown", (e) => {
      if (e.key !== "Enter") return;
      const q = e.target.value.trim().toLowerCase();
      if (!q) return;

      const hit = cy.nodes().filter(n => {
        const d = n.data();
        return Object.values(d).some(v => String(v).toLowerCase().includes(q));
      }).first();

      if (hit && hit.length) {
        // Reveal node and neighbors so user can see it
        hit.removeClass("hidden");
        expandOneHop(hit);
        showDetails(hit);

        cy.animate({ center: { eles: hit }, zoom: 1.2 }, { duration: 250 });
        highlightNeighborhood(hit);
        setTimeout(() => clearHighlights(), 900);
      }
    });

    // Start view: anchors only, no expansion
    showAnchorsOnly();
  }

  main().catch(err => {
    console.error(err);
    document.getElementById("details").innerHTML =
      "<b>Error</b><br><br>" + String(err);
  });
</script>
</body>
</html>
